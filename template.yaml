apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: Github-pages-deploy-from-github
  title: Deploy to Github pages from GitHub Repo
  description: Create and deploy a Docker container from a GitHub repository URL.
spec:
  owner: user:guest
  type: service

  
  parameters:
    - title: GitHub Repository URL
      required: 
        - Github_URL
        #- Dockerfile
        #- Port
      properties:
        Github_URL:
          title: Enter you Github URL
          type: string
          description: Enter the github URL where your code exists
          ui:autofocus: true

    - title: Select where you want to deploy your code
      required:
        - stack
      properties:
        stack:
          title: Select from below list
          type: string
          enum:
            - Docker
            - Github pages
            - Baremetal
            - Kubernetes
  
    - title: Enter below details
      dependencies:
        stack:
          oneOf:
            - properties:
                stack:
                  const: Docker
                extraFields:          # ğŸ‘ˆ wrap everything else inside a schema key
                  title: Enter the details
                  type: object
                  properties:
                    Dockerfile:
                      title: Enter the Path of Dockerfile
                      type: string
                      description: Enter the Dockerfile path (e.g. build/Dockerfile or enter Dockerfile if it is in root) 
                      default: "Dockerfile" 
                    Port:
                      title: Enter the Port number
                      type: integer
                      minimum: 1
                      maximum: 65535
                      description: Enter the Port number of your application (e.g. 80/3000/5000)
  
            - properties:
                stack:
                  const: Github pages
                extraFields:
                  type: object
                  properties: 
                    # Github:
                    #   title: Enter the Path of Github Url
                    #   type: string
                    #   description: Enter the Github URL 
                      
                      
                    GithubToken:
                      title: Enter the Github Token
                      type: string
                      description: Enter the token
                       
  
            - properties:
                stack:
                  const: Baremetal
                extraFields:
                  type: object
                  properties: {}
            
            - properties:
                stack:
                  const: Kubernetes
                extraFields:
                  title: Kubernetes Deployment Details
                  type: object
                  properties:
                    DeploymentFile:
                      title: Deployment Manifest Path
                      type: string
                      description: Path to your deployment YAML file (relative to repo)
                      default: "deployment.yaml"
                    ServiceFile:
                      title: Service Manifest Path
                      type: string
                      description: Path to your service YAML file (relative to repo)
                      default: "service.yaml"
                    Namespace:
                      title: Kubernetes Namespace (optional)
                      type: string
                      description: Namespace to deploy into (leave blank for default)
                      default: "default"
          
  steps:

    - id: fetch
      name: Fetch GitHub Repo
      action: fetch:plain
      input:
        url: ${{ parameters.Github_URL }}
        targetPath: ./site  # fetch code into ./site folder

    - id: fetch-kube
      name: Fetch Kubernetes Manifests
      if: ${{ parameters.stack == 'Kubernetes' }}
      action: fetch:plain
      input:
        url: ${{ parameters.Github_URL }}
        targetPath: ./kube
        
    - id: apply-kube
      name: Deploy to Kubernetes via Minikube
      if: ${{ parameters.stack == 'Kubernetes' }}
      action: shell:run
      input:
        cwd: ./kube
        command: bash
        args:
          - -c
          - |
            set -euo pipefail
            echo "ğŸš€ Applying manifests to Minikube cluster..."
    
            NAMESPACE="${{ parameters.extraFields.Namespace }}"
            DEPLOY="${{ parameters.extraFields.DeploymentFile }}"
            SERVICE="${{ parameters.extraFields.ServiceFile }}"
    
            echo "ğŸ“ Using namespace: $NAMESPACE"
            kubectl get ns "$NAMESPACE" >/dev/null 2>&1 || kubectl create ns "$NAMESPACE"
    
            echo "ğŸ“¦ Applying deployment..."
            kubectl apply -f "$DEPLOY" -n "$NAMESPACE"
    
            echo "ğŸ”§ Applying service..."
            kubectl apply -f "$SERVICE" -n "$NAMESPACE"
    
            echo "âœ… Deployment and Service applied successfully!"
    
            echo "ğŸ” Fetching service details..."
            SVC_NAME=$(kubectl get -f "$SERVICE" -n "$NAMESPACE" -o jsonpath='{.metadata.name}' 2>/dev/null || kubectl get svc -n "$NAMESPACE" --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}')
            NODE_PORT=$(kubectl get svc "$SVC_NAME" -n "$NAMESPACE" -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "")
            CLUSTER_IP=$(kubectl get svc "$SVC_NAME" -n "$NAMESPACE" -o jsonpath='{.spec.clusterIP}')
            CLUSTER_PORT=$(kubectl get svc "$SVC_NAME" -n "$NAMESPACE" -o jsonpath='{.spec.ports[0].port}')
    
            EXTERNAL_URL=""
            if command -v minikube >/dev/null 2>&1; then
              MINIKUBE_IP=$(minikube ip 2>/dev/null || echo "")
              if [[ -n "$MINIKUBE_IP" && -n "$NODE_PORT" ]]; then
                EXTERNAL_URL="http://$MINIKUBE_IP:$NODE_PORT"
              fi
            fi
    
            if [[ -z "$EXTERNAL_URL" && -n "$CLUSTER_IP" && -n "$CLUSTER_PORT" ]]; then
              EXTERNAL_URL="http://$CLUSTER_IP:$CLUSTER_PORT"
            fi
    
            echo "ğŸŒ Application accessible at: $EXTERNAL_URL"
            echo "$EXTERNAL_URL" > url.txt
    - id: show-url
      name: Show Service URL
      if: ${{ parameters.stack == 'Kubernetes' }}
      action: debug:log
      input:
        message: |
          âœ… Your service has been deployed!
          ğŸŒ Access it here: $(cat ./kube/url.txt || echo "URL not found")
